
function BlockEdrIp($EdrIp)
{        
    $Params =@{ 
              DisplayName = "nofw4u"; 
              RemoteAddress = $EdrIp; 
              Action = "Block"; 
              Profile = "Any"
              Enable = "True" }

    Set-NetFirewallRule @params
}

function GetEdrIp()
{
    return (Get-NetTCPConnection).where({
        $_.state -eq "Established" -AND $_.RemotePort -eq 443 -AND $_.owningprocess -eq 4 }).remoteaddress
}

$BlockList = @()
$null = New-NetFirewallRule -DisplayName "nofw4u" -Direction Outbound -Enabled True -Profile Any

while($true)
{
    (GetEdrIp).ForEach({
            if($_ -AND $_ -notin $BlockList)
            {
                BlockEdrIp $_
                $BlockList += $_ 
                "$([DateTime]::Now) - Added $_ to block list ($($BlockList.Count) total) "
            }
        })

    
}
